<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PowerGenome Region Clustering</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet Draw for box selection -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.11.1/core.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
        }

        /* Hide PyScript terminal/stderr output (deprecation warnings) */
        script[type="py"]+* .py-terminal,
        .py-terminal,
        .py-error,
        [id^="py-"] {
            display: none !important;
        }

        #app {
            display: grid;
            grid-template-columns: 340px 1fr;
            height: 100%;
        }

        #sidebar {
            padding: 16px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            background: #fafafa;
        }

        #sidebar h2 {
            margin: 0 0 16px 0;
            font-size: 18px;
        }

        .section {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }

        select,
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-primary:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .checkbox-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            background: white;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .checkbox-group input {
            margin-right: 8px;
        }

        .ba-list {
            max-height: 120px;
            overflow-y: auto;
            font-size: 12px;
            background: white;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .ba-tag {
            display: inline-block;
            padding: 2px 6px;
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 3px;
            margin: 2px;
            font-size: 11px;
        }

        .ba-tag.unclustered {
            background: #fff3e0;
            border-color: #ffb74d;
        }

        #yamlOut,
        #plantYamlOut {
            width: 100%;
            height: 180px;
            font-family: monospace;
            font-size: 11px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
        }

        #map {
            height: 100%;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }

        .legend {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            margin-right: 8px;
            border: 1px solid #999;
        }

        /* Box selection mode */
        .selection-mode {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .mode-btn {

            .tab-bar {
                display: flex;
                gap: 6px;
                margin-bottom: 12px;
            }

            .tab-btn {
                flex: 1;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                background: white;
                cursor: pointer;
                font-weight: 600;
                transition: background 0.2s, color 0.2s, border-color 0.2s;
            }

            .tab-btn.active {
                background: #0066cc;
                color: white;
                border-color: #0066cc;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .candidate-item {
                padding: 6px 8px;
                border: 1px solid #eee;
                border-radius: 4px;
                margin-bottom: 6px;
                background: #fff;
                font-size: 12px;
            }

            .group-editor {
                margin-top: 8px;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                padding: 10px;
                background: #fff;
            }

            .dual-list {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 8px;
                align-items: center;
            }

            .dual-list select {
                height: 180px;
                width: 100%;
            }

            .dual-buttons {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .small-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .group-empty {
                font-size: 12px;
                color: #666;
                margin-top: 6px;
            }

            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            background: #f0f0f0;
        }

        .mode-btn.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        #map.box-select-mode {
            cursor: crosshair;
        }

        .selection-box {
            position: absolute;
            border: 2px dashed #0066cc;
            background: rgba(0, 102, 204, 0.1);
            pointer-events: none;
            z-index: 1000;
        }

        /* Instructions panel */
        .instructions {
            background: #fff8e1;
            border: 1px solid #ffcc02;
            border-radius: 6px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            background: #fff3c4;
            font-weight: 500;
        }

        .instructions-header:hover {
            background: #ffecb3;
        }

        .instructions-toggle {
            font-size: 12px;
            color: #666;
        }

        .instructions-content {
            padding: 12px;
            font-size: 13px;
            line-height: 1.5;
            border-top: 1px solid #ffe082;
        }

        .instructions-content.hidden {
            display: none;
        }

        .instructions-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .instructions-content li {
            margin-bottom: 6px;
        }

        .instructions-content code {
            background: #fff;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        .instructions-content .tip {
            background: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="loadingText">Loading PyScript and dependencies...</div>
    </div>

    <div id="app">
        <div id="sidebar">
            <h2>‚ö° PowerGenome Clustering</h2>

            <div class="tab-bar">
                <button class="tab-btn active" id="regionTabBtn" data-tab="regionTab">Regions</button>
                <button class="tab-btn" id="plantTabBtn" data-tab="plantTab">Plants</button>
            </div>

            <div id="statusBox" class="status info">Click BAs on the map to select them for clustering.</div>

            <div id="regionTab" class="tab-content active">
                <div class="instructions">
                    <div class="instructions-header" onclick="toggleInstructions()">
                        <span>üìñ How to Use</span>
                        <span class="instructions-toggle" id="instructionsToggle">‚ñº Hide</span>
                    </div>
                    <div class="instructions-content" id="instructionsContent">
                        <ol>
                            <li><strong>Select BAs:</strong> Click on regions in the map to select them. Use <strong>Box
                                    Select</strong> mode to drag and select multiple BAs at once.</li>
                            <li><strong>Choose grouping:</strong> The <em>Grouping Column</em> determines how BAs are
                                grouped for clustering (colored outlines show groups).</li>
                            <li><strong>Set target regions:</strong> Enter how many final regions you want after
                                clustering.
                                Optionally enable <em>Auto-optimize</em> to find the best number of regions within a
                                range.
                            </li>
                            <li><strong>Exclude groups:</strong> Check any groups in <em>Groups to Keep Unclustered</em>
                                to
                                keep them as individual BAs.</li>
                            <li><strong>Run clustering:</strong> Click <em>Run Clustering</em> to generate the region
                                aggregations.</li>
                            <li><strong>Export:</strong> Copy or download the YAML output to use in PowerGenome.</li>
                        </ol>
                        <div class="tip">
                            üí° <strong>Tip:</strong> The clustering uses transmission capacity between BAs to create
                            aggregated regions. BAs are first clustered within their selected grouping (e.g., NERC
                            region),
                            then groups are merged to reach the target number of regions. The selected grouping affects
                            the
                            clustering results, so experiment with different options to see what works best for your
                            case!
                        </div>
                    </div>
                </div>

                <script>
                    function toggleInstructions() {
                        const content = document.getElementById('instructionsContent');
                        const toggle = document.getElementById('instructionsToggle');
                        if (content.classList.contains('hidden')) {
                            content.classList.remove('hidden');
                            toggle.textContent = '‚ñº Hide';
                        } else {
                            content.classList.add('hidden');
                            toggle.textContent = '‚ñ∂ Show';
                        }
                    }

                    function toggleAutoOptimize() {
                        const checkbox = document.getElementById('autoOptimize');
                        const fixedRow = document.getElementById('fixedTargetRow');
                        const rangeRow = document.getElementById('rangeTargetRow');
                        if (checkbox.checked) {
                            fixedRow.style.display = 'none';
                            rangeRow.style.display = 'block';
                        } else {
                            fixedRow.style.display = 'block';
                            rangeRow.style.display = 'none';
                        }
                    }

                    function switchTab(tabId) {
                        document.querySelectorAll('.tab-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.tab === tabId);
                        });
                        document.querySelectorAll('.tab-content').forEach(panel => {
                            panel.classList.toggle('active', panel.id === tabId);
                        });
                    }

                    document.addEventListener('DOMContentLoaded', function () {
                        document.getElementById('autoOptimize').addEventListener('change', toggleAutoOptimize);
                        document.getElementById('regionTabBtn').addEventListener('click', () => switchTab('regionTab'));
                        document.getElementById('plantTabBtn').addEventListener('click', () => switchTab('plantTab'));
                    });
                </script>

                <div class="section">
                    <label>Grouping Column</label>
                    <select id="groupingColumn">
                        <option value="nercr" selected>nercr (NERC Region)</option>
                        <option value="transreg">transreg (Transmission Region)</option>
                        <option value="transgrp">transgrp (Transmission Group)</option>
                        <option value="st">st (State)</option>
                        <option value="interconnect">interconnect</option>
                        <option value="cendiv">cendiv (Census Division)</option>
                    </select>
                </div>

                <div class="section">
                    <label>Number of Regions</label>
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" id="autoOptimize" style="width: auto; margin: 0;">
                            Auto-optimize
                        </label>
                    </div>
                    <div id="fixedTargetRow">
                        <label style="font-size: 12px;">Target</label>
                        <input id="targetRegions" type="number" value="10" min="1" max="134" />
                    </div>
                    <div id="rangeTargetRow" style="display: none;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px;">Min</label>
                                <input id="minRegions" type="number" value="5" min="1" max="134" />
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px;">Max</label>
                                <input id="maxRegions" type="number" value="20" min="1" max="134" />
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            Picks best modularity score
                        </div>
                    </div>
                </div>

                <div class="section">
                    <label>Groups to Keep Unclustered</label>
                    <div id="noClusterContainer" class="checkbox-group">
                        <em>Loading...</em>
                    </div>
                </div>

                <div class="section">
                    <label>Selection Mode</label>
                    <div class="selection-mode">
                        <button class="mode-btn" id="clickModeBtn" title="Click individual BAs">üñ±Ô∏è Click</button>
                        <button class="mode-btn active" id="boxModeBtn" title="Drag to select multiple BAs">‚¨ú Box
                            Select</button>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 8px;" id="selectionHint">
                        Drag on the map to select multiple BAs
                    </div>
                </div>

                <div class="section">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="showTransmissionLines" style="width: auto; margin: 0;">
                        Show Transmission Lines
                    </label>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Line thickness indicates capacity
                    </div>
                </div>

                <div class="section">
                    <button class="btn btn-primary" id="runBtn" disabled>Run Clustering</button>
                    <button class="btn btn-secondary" id="selectAllBtn">Select All</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">Clear</button>
                </div>

                <div class="section">
                    <label>Selected BAs (<span id="selectedCount">0</span> of <span id="totalCount">134</span>)</label>
                    <div id="selectedList" class="ba-list">
                        <em>None selected</em>
                    </div>
                </div>

                <div class="section">
                    <label>YAML Output</label>
                    <textarea id="yamlOut" readonly placeholder="Run clustering to generate YAML..."></textarea>
                    <button class="btn btn-secondary" id="copyYamlBtn">Copy</button>
                    <button class="btn btn-secondary" id="downloadYamlBtn">Download</button>
                </div>
            </div>

            <div id="plantTab" class="tab-content">
                <div class="section">
                    <div style="font-size: 13px; color: #444;">
                        Cluster existing generators inside the current model regions. If you have not run region
                        clustering yet, plants are grouped by their BA.
                    </div>
                </div>
                <div class="section">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="groupTechDefault" style="width: auto; margin: 0;" checked>
                        Group similar technologies
                    </label>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Manage groups below. Defaults start with Biomass and Other peaker.
                    </div>
                    <div class="group-editor">
                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                            <input id="newGroupName" type="text" placeholder="New group name"
                                style="flex: 1; padding: 6px;">
                            <button class="btn btn-secondary" id="addGroupBtn" type="button">Add Group</button>
                            <button class="btn btn-secondary" id="resetGroupsBtn" type="button">Reset Defaults</button>
                            <button class="btn btn-secondary" id="clearGroupsBtn" type="button">Clear Groups</button>
                        </div>
                        <div style="margin-bottom: 6px; display: flex; gap: 8px; align-items: center;">
                            <label style="font-size: 12px;">Select group:</label>
                            <select id="groupSelectDual" style="flex: 1; padding: 6px;"></select>
                        </div>
                        <div id="groupEmptyNotice" class="group-empty" style="display:none;">Add a group to begin
                            assigning technologies.</div>
                        <div class="dual-list">
                            <div>
                                <div style="font-size: 12px; margin-bottom: 4px;">Available technologies</div>
                                <select id="availableList" multiple></select>
                            </div>
                            <div class="dual-buttons">
                                <button class="btn btn-secondary small-btn" id="moveToGroupBtn"
                                    type="button">&gt;&gt;</button>
                                <button class="btn btn-secondary small-btn" id="moveToAvailableBtn"
                                    type="button">&lt;&lt;</button>
                            </div>
                            <div>
                                <div style="font-size: 12px; margin-bottom: 4px;">In selected group</div>
                                <select id="groupList" multiple></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <label>Omit technologies (select one or more)</label>
                    <select id="omitTechSelect" multiple size="4" style="width: 100%; padding: 6px;">
                        <option value="all other" selected>All Other</option>
                        <option value="solar thermal" selected>Solar thermal</option>
                        <option value="flywheel" selected>Flywheel</option>
                    </select>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Selected technologies are excluded from clustering.
                    </div>
                </div>
                <div class="section">
                    <label>Total Cluster Budget</label>
                    <input id="plantBudget" type="number" value="200" min="1" />
                    <div id="plantBudgetInfo" style="font-size: 11px; color: #666; margin-top: 4px;">Hard cap across all
                        tech/region combinations. Minimum and default will update after data loads.</div>
                </div>
                <div class="section">
                    <label>Capacity Threshold (MW)</label>
                    <input id="capThreshold" type="number" value="1500" min="0" step="100" />
                </div>
                <div class="section">
                    <label>Heat-rate IQR Threshold (mmbtu/MWh)</label>
                    <input id="hrThreshold" type="number" value="0.8" min="0" step="0.05" />
                </div>
                <div class="section">
                    <button class="btn btn-primary" id="runPlantBtn">Run Plant Clustering</button>
                    <button class="btn btn-secondary" id="copyPlantYamlBtn">Copy</button>
                    <button class="btn btn-secondary" id="downloadPlantYamlBtn">Download</button>
                </div>
                <div class="section">
                    <div id="plantResultText" class="status info">Run plant clustering to see results here.</div>
                </div>
                <div class="section">
                    <label>Plant YAML</label>
                    <textarea id="plantYamlOut" readonly
                        placeholder="Run plant clustering to generate YAML..."></textarea>
                </div>
                <div class="section">
                    <label>Top candidates for more splits</label>
                    <div id="plantCandidateList" class="ba-list">
                        <em>Run plant clustering to see suggestions.</em>
                    </div>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Box selection helper (pure JS for responsiveness) -->
    <script>
        // Box selection state
        window.boxSelectState = {
            enabled: false,
            isDrawing: false,
            startPoint: null,
            boxElement: null
        };

        // Get selected BAs within bounds (called from Python)
        window.getBAsInBounds = function (bounds) {
            return [];
        };
    </script>

    <!-- PyScript config and app -->
    <script type="py" src="./cluster_app.py" config="./pyscript.toml"></script>
</body>

</html>