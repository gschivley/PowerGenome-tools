<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PowerGenome Region Clustering</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet Draw for box selection -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.11.1/core.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
        }

        /* Hide PyScript terminal/stderr output (deprecation warnings) */
        script[type="py"]+* .py-terminal,
        .py-terminal,
        .py-error,
        [id^="py-"] {
            display: none !important;
        }

        #app {
            display: grid;
            grid-template-columns: 340px 1fr;
            height: 100%;
        }

        #sidebar {
            padding: 16px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            background: #fafafa;
            position: relative;
        }

        #sidebarResizer {
            position: absolute;
            top: 0;
            right: -3px;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
            z-index: 10;
        }

        #sidebarResizer:hover {
            background: rgba(0, 0, 0, 0.06);
        }

        body.resizing {
            cursor: col-resize;
            user-select: none;
        }

        #sidebar h2 {
            margin: 0 0 16px 0;
            font-size: 18px;
        }

        .section {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }

        select,
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-primary:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .checkbox-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            background: white;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .checkbox-group input {
            margin-right: 8px;
        }

        .ba-list {
            max-height: 120px;
            overflow-y: auto;
            font-size: 12px;
            background: white;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .ba-tag {
            display: inline-block;
            padding: 2px 6px;
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 3px;
            margin: 2px;
            font-size: 11px;
        }

        .ba-tag.unclustered {
            background: #fff3e0;
            border-color: #ffb74d;
        }

        #yamlOut,
        #plantYamlOut {
            width: 100%;
            height: 180px;
            font-family: monospace;
            font-size: 11px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
        }

        #map {
            height: 100%;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }

        .legend {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            margin-right: 8px;
            border: 1px solid #999;
        }

        /* Box selection mode */
        .selection-mode {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .mode-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tab-bar {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }

        .tab-btn.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .candidate-item {
            padding: 6px 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 6px;
            background: #fff;
            font-size: 12px;
        }

        /* Tooltip styles */
        .info-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            line-height: 14px;
            text-align: center;
            border-radius: 50%;
            background: #999;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }

        .info-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 200px;
            padding: 8px;
            background: #333;
            color: white;
            font-size: 11px;
            border-radius: 4px;
            z-index: 1000;
            font-weight: normal;
            line-height: 1.4;
            margin-bottom: 6px;
            white-space: normal;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .group-editor {
            margin-top: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            background: #fff;
        }

        .dual-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dual-list select {
            height: 120px;
            width: 100%;
        }

        .dual-buttons {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 12px;
            margin: 4px 0;
        }

        .small-btn {
            padding: 6px 10px;
            font-size: 12px;
        }

        .group-empty {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }

        .mode-btn:hover {
            background: #f0f0f0;
        }

        .mode-btn.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        #map.box-select-mode {
            cursor: crosshair;
        }

        .selection-box {
            position: absolute;
            border: 2px dashed #0066cc;
            background: rgba(0, 102, 204, 0.1);
            pointer-events: none;
            z-index: 1000;
        }

        /* Instructions panel */
        .instructions {
            background: #fff8e1;
            border: 1px solid #ffcc02;
            border-radius: 6px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            background: #fff3c4;
            font-weight: 500;
        }

        .instructions-header:hover {
            background: #ffecb3;
        }

        .instructions-toggle {
            font-size: 12px;
            color: #666;
        }

        .instructions-content {
            padding: 12px;
            font-size: 13px;
            line-height: 1.5;
            border-top: 1px solid #ffe082;
        }

        .instructions-content.hidden {
            display: none;
        }

        .instructions-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .instructions-content li {
            margin-bottom: 6px;
        }

        .instructions-content code {
            background: #fff;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        .instructions-content .tip {
            background: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="loadingText">Loading PyScript and dependencies...</div>
    </div>

    <div id="app">
        <div id="sidebar">
            <div id="sidebarResizer" title="Drag to resize sidebar"></div>
            <h2>‚ö° PowerGenome Clustering</h2>
            <div style="margin-bottom: 16px; font-size: 13px;">
                <a href="https://gschivley.github.io/PowerGenome-tools/" target="_blank"
                    style="color: #0066cc; text-decoration: none;">üìö View Documentation</a>
            </div>

            <div class="tab-bar">
                <button class="tab-btn active" id="regionTabBtn" data-tab="regionTab">Regions</button>
                <button class="tab-btn" id="plantTabBtn" data-tab="plantTab">Plants</button>
                <button class="tab-btn" id="settingsTabBtn" data-tab="settingsTab">Settings</button>
            </div>

            <div id="statusBox" class="status info">Click BAs on the map to select them for clustering.</div>

            <div id="regionTab" class="tab-content active">
                <div class="instructions">
                    <div class="instructions-header" onclick="toggleInstructions()">
                        <span>üìñ How to Use</span>
                        <span class="instructions-toggle" id="instructionsToggle">‚ñ∂ Show</span>
                    </div>
                    <div class="instructions-content hidden" id="instructionsContent">
                        <ol>
                            <li><strong>Select BAs:</strong> Click on regions in the map to select them. Use <strong>Box
                                    Select</strong> mode (default) to drag and select multiple BAs at once.</li>
                            <li><strong>Choose grouping:</strong> The <em>Grouping Column</em> determines how BAs are
                                grouped for clustering. Colored outlines on the map show these groups.</li>
                            <li><strong>Set target regions:</strong> Enter how many final regions you want.
                                Enable <em>Auto-optimize</em> to find the best number of regions within a
                                range based on transmission modularity.
                            </li>
                            <li><strong>Exclude groups:</strong> Check any groups in <em>Groups to Keep Unclustered</em>
                                to keep them as individual BAs (they will not be merged with others).</li>
                            <li><strong>Run clustering:</strong> Click <em>Run Clustering</em> to generate the region
                                aggregations. The map will update to show the new regions.</li>
                            <li><strong>Export:</strong> Copy or download the YAML output to use in your PowerGenome
                                configuration.</li>
                        </ol>
                        <div class="tip">
                            üí° <strong>Tip:</strong> The clustering uses transmission capacity between BAs to create
                            aggregated regions. BAs are first clustered within their selected grouping (e.g., NERC
                            region), then groups are merged to reach the target number of regions.
                        </div>
                    </div>
                </div>

                <script>
                    function toggleInstructions() {
                        const content = document.getElementById('instructionsContent');
                        const toggle = document.getElementById('instructionsToggle');
                        if (content.classList.contains('hidden')) {
                            content.classList.remove('hidden');
                            toggle.textContent = '‚ñº Hide';
                        } else {
                            content.classList.add('hidden');
                            toggle.textContent = '‚ñ∂ Show';
                        }
                    }

                    function toggleAutoOptimize() {
                        const checkbox = document.getElementById('autoOptimize');
                        const fixedRow = document.getElementById('fixedTargetRow');
                        const rangeRow = document.getElementById('rangeTargetRow');
                        const methodSection = document.getElementById('clusteringMethodSection');

                        if (checkbox.checked) {
                            fixedRow.style.display = 'none';
                            rangeRow.style.display = 'block';
                            if (methodSection) methodSection.style.display = 'none';
                        } else {
                            fixedRow.style.display = 'block';
                            rangeRow.style.display = 'none';
                            if (methodSection) methodSection.style.display = 'block';
                        }
                    }

                    function switchTab(tabId) {
                        document.querySelectorAll('.tab-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.tab === tabId);
                        });
                        document.querySelectorAll('.tab-content').forEach(panel => {
                            panel.classList.toggle('active', panel.id === tabId);
                        });
                    }

                    document.addEventListener('DOMContentLoaded', function () {
                        document.getElementById('autoOptimize').addEventListener('change', toggleAutoOptimize);
                        document.getElementById('regionTabBtn').addEventListener('click', () => switchTab('regionTab'));
                        document.getElementById('plantTabBtn').addEventListener('click', () => switchTab('plantTab'));
                        document.getElementById('settingsTabBtn').addEventListener('click', () => switchTab('settingsTab'));
                    });
                </script>

                <script>
                    (function () {
                        const app = document.getElementById('app');
                        const sidebar = document.getElementById('sidebar');
                        const resizer = document.getElementById('sidebarResizer');
                        if (!app || !sidebar || !resizer) return;

                        const MIN_W = 260;
                        const MAX_W = 700;

                        let startX = 0;
                        let startW = 0;
                        let dragging = false;

                        function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

                        function setSidebarWidth(px) {
                            app.style.gridTemplateColumns = `${px}px 1fr`;
                            // Encourage Leaflet to recalc size
                            window.dispatchEvent(new Event('resize'));
                            if (window.appMap && typeof window.appMap.invalidateSize === 'function') {
                                window.appMap.invalidateSize(false);
                            }
                        }

                        resizer.addEventListener('mousedown', (e) => {
                            dragging = true;
                            startX = e.clientX;
                            startW = sidebar.getBoundingClientRect().width;
                            document.body.classList.add('resizing');
                            e.preventDefault();
                        });

                        window.addEventListener('mousemove', (e) => {
                            if (!dragging) return;
                            const dx = e.clientX - startX;
                            const w = clamp(Math.round(startW + dx), MIN_W, MAX_W);
                            setSidebarWidth(w);
                        });

                        window.addEventListener('mouseup', () => {
                            if (!dragging) return;
                            dragging = false;
                            document.body.classList.remove('resizing');
                            // One more invalidate at end
                            if (window.appMap && typeof window.appMap.invalidateSize === 'function') {
                                window.appMap.invalidateSize(false);
                            }
                        });
                    })();
                </script>

                <div class="section">
                    <label>Grouping Column</label>
                    <select id="groupingColumn">
                        <option value="transgrp" selected>transgrp (Transmission Group)</option>
                        <option value="transreg">transreg (Transmission Region)</option>
                        <option value="nercr">nercr (NERC Region)</option>
                        <option value="interconnect">interconnect</option>
                        <option value="st">st (State)</option>
                        <option value="cendiv">cendiv (Census Division)</option>
                    </select>
                </div>

                <div class="section">
                    <label>Number of Regions</label>
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" id="autoOptimize" style="width: auto; margin: 0;">
                            Auto-optimize
                        </label>
                        <span class="info-icon"
                            data-tooltip="Uses Louvain clustering to automatically determine the optimal number of regions based on modularity.">?</span>
                    </div>
                    <div id="fixedTargetRow">
                        <label style="font-size: 12px;">Target</label>
                        <input id="targetRegions" type="number" value="10" min="1" max="134" />
                    </div>
                    <div id="rangeTargetRow" style="display: none;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px;">Min</label>
                                <input id="minRegions" type="number" value="20" min="1" max="134" />
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px;">Max</label>
                                <input id="maxRegions" type="number" value="40" min="1" max="134" />
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            Picks best modularity score
                        </div>
                    </div>
                </div>

                <div class="section" id="clusteringMethodSection">
                    <label>Clustering Method</label>
                    <select id="clusteringMethod">
                        <option value="spectral" selected>Spectral Clustering</option>
                        <option value="louvain">Louvain (Fixed)</option>
                        <option value="hierarchical-average">Hierarchical (Average Linkage)</option>
                        <option value="hierarchical-max">Hierarchical (Max Linkage)</option>
                        <option value="hierarchical-sum">Hierarchical (Sum Linkage)</option>
                    </select>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Algorithm used to merge regions.
                    </div>
                </div>

                <div class="section">
                    <label>Groups to Keep Unclustered</label>
                    <div id="noClusterContainer" class="checkbox-group">
                        <em>Loading...</em>
                    </div>
                </div>

                <div class="section">
                    <label>Selection Mode</label>
                    <div class="selection-mode">
                        <button class="mode-btn" id="clickModeBtn" title="Click individual BAs">üñ±Ô∏è Click</button>
                        <button class="mode-btn active" id="boxModeBtn" title="Drag to select multiple BAs">‚¨ú Box
                            Select</button>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 8px;" id="selectionHint">
                        Drag on the map to select multiple BAs
                    </div>
                </div>

                <div class="section">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="showTransmissionLines" style="width: auto; margin: 0;">
                        Show Transmission Lines
                    </label>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Line thickness indicates capacity
                    </div>
                </div>

                <div class="section">
                    <button class="btn btn-primary" id="runBtn" disabled>Run Clustering</button>
                    <button class="btn btn-secondary" id="selectAllBtn">Select All</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">Clear</button>
                </div>

                <div class="section">
                    <label>Selected BAs (<span id="selectedCount">0</span> of <span id="totalCount">134</span>)</label>
                    <div id="selectedList" class="ba-list">
                        <em>None selected</em>
                    </div>
                </div>

                <div class="section">
                    <label>YAML Output</label>
                    <textarea id="yamlOut" readonly placeholder="Run clustering to generate YAML..."></textarea>
                    <button class="btn btn-secondary" id="copyYamlBtn">Copy</button>
                    <button class="btn btn-secondary" id="downloadYamlBtn">Download</button>
                </div>
            </div>

            <div id="plantTab" class="tab-content">
                <div class="instructions">
                    <div class="instructions-header" onclick="togglePlantInstructions()">
                        <span>üìñ How to Use</span>
                        <span class="instructions-toggle" id="plantInstructionsToggle">‚ñ∂ Show</span>
                    </div>
                    <div class="instructions-content hidden" id="plantInstructionsContent">
                        <ol>
                            <li><strong>Group similar technologies:</strong> Check "Group similar technologies" to
                                automatically group related tech types (e.g., Biomass). You can customize these groups
                                using the editor below.</li>
                            <li><strong>Omit technologies:</strong> Use the dual-list to move technologies you want to
                                exclude from clustering to the <em>Omitted technologies</em> column. "All Other",
                                "Flywheel", and "Solar thermal" variants are omitted by default.</li>
                            <li><strong>Set cluster budget:</strong> Specify the total number of clusters across all
                                technologies and regions. The default is set to 15% above the minimum required (one
                                cluster per tech/region combination).</li>
                            <li><strong>Adjust thresholds:</strong> Modify <em>Capacity Threshold</em> (MW)
                                and <em>Heat-rate IQR Threshold</em> to control when generators are suggested for
                                splitting into multiple clusters.</li>
                            <li><strong>Run clustering:</strong> Click <em>Run Plant Clustering</em> to generate cluster
                                assignments.</li>
                            <li><strong>Review suggestions:</strong> Check the "Top candidates for more splits" list to
                                see which tech/region groups would benefit most from a higher budget.</li>
                            <li><strong>Export:</strong> Copy or download the YAML output for PowerGenome.</li>
                        </ol>
                        <div class="tip">
                            üí° <strong>Tip:</strong> Plant clustering respects the model regions created in the Regions
                            tab. If you haven't run region clustering yet, plants are grouped by their original BA.
                        </div>
                    </div>
                </div>
                <script>
                    function togglePlantInstructions() {
                        const content = document.getElementById('plantInstructionsContent');
                        const toggle = document.getElementById('plantInstructionsToggle');
                        if (content.classList.contains('hidden')) {
                            content.classList.remove('hidden');
                            toggle.textContent = '‚ñº Hide';
                        } else {
                            content.classList.add('hidden');
                            toggle.textContent = '‚ñ∂ Show';
                        }
                    }
                </script>
                <div class="section">
                    <div style="font-size: 13px; color: #444;">
                        Cluster existing generators inside the current model regions. If you have not run region
                        clustering yet, plants are grouped by their BA.
                    </div>
                </div>
                <div class="section">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="groupTechDefault" style="width: auto; margin: 0;" checked>
                        Group similar technologies
                    </label>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Manage groups below. Defaults start with Biomass and Other peaker.
                    </div>
                    <div class="group-editor">
                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                            <input id="newGroupName" type="text" placeholder="New group name"
                                style="flex: 1; padding: 6px;">
                            <button class="btn btn-secondary" id="addGroupBtn" type="button">Add Group</button>
                            <button class="btn btn-secondary" id="resetGroupsBtn" type="button">Reset Defaults</button>
                            <button class="btn btn-secondary" id="clearGroupsBtn" type="button">Clear Groups</button>
                        </div>
                        <div style="margin-bottom: 6px; display: flex; gap: 8px; align-items: center;">
                            <label style="font-size: 12px;">Select group:</label>
                            <select id="groupSelectDual" style="flex: 1; padding: 6px;"></select>
                        </div>
                        <div id="groupEmptyNotice" class="group-empty" style="display:none;">Add a group to begin
                            assigning technologies.</div>
                        <div class="dual-list">
                            <div>
                                <div style="font-size: 12px; margin-bottom: 4px;">Available technologies</div>
                                <select id="availableList" multiple></select>
                            </div>
                            <div class="dual-buttons">
                                <button class="btn btn-secondary small-btn" id="moveToGroupBtn" type="button">Add
                                    ‚Üì</button>
                                <button class="btn btn-secondary small-btn" id="moveToAvailableBtn" type="button">Remove
                                    ‚Üë</button>
                            </div>
                            <div>
                                <div style="font-size: 12px; margin-bottom: 4px;">In selected group</div>
                                <select id="groupList" multiple></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <label>Omit technologies</label>
                    <div class="dual-list">
                        <div>
                            <div style="font-size: 12px; margin-bottom: 4px;">Available technologies</div>
                            <select id="omitAvailableList" multiple size="8"></select>
                        </div>
                        <div class="dual-buttons">
                            <button class="btn btn-secondary small-btn" id="omitMoveToSelectedBtn" type="button">Omit
                                ‚Üì</button>
                            <button class="btn btn-secondary small-btn" id="omitMoveToAvailableBtn"
                                type="button">Include ‚Üë</button>
                        </div>
                        <div>
                            <div style="font-size: 12px; margin-bottom: 4px;">Omitted technologies</div>
                            <select id="omitSelectedList" multiple size="8"></select>
                        </div>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-secondary small-btn" id="omitResetBtn" type="button">Reset
                            defaults</button>
                        <div style="font-size: 11px; color: #666;">All Other, Flywheel, and Solar thermal technologies
                            start omitted.</div>
                    </div>
                </div>
                <div class="section">
                    <label>Total Cluster Budget</label>
                    <input id="plantBudget" type="number" value="200" min="1" />
                    <div id="plantBudgetInfo" style="font-size: 11px; color: #666; margin-top: 4px;">Hard cap across all
                        tech/region combinations. Minimum and default will update after data loads.</div>
                </div>
                <div class="section">
                    <label>Capacity Threshold (MW)</label>
                    <input id="capThreshold" type="number" value="1500" min="0" step="100" />
                </div>
                <div class="section">
                    <label>Heat-rate IQR Threshold (mmbtu/MWh)</label>
                    <input id="hrThreshold" type="number" value="0.8" min="0" step="0.05" />
                </div>
                <div class="section">
                    <button class="btn btn-primary" id="runPlantBtn">Run Plant Clustering</button>
                    <button class="btn btn-secondary" id="copyPlantYamlBtn">Copy</button>
                    <button class="btn btn-secondary" id="downloadPlantYamlBtn">Download</button>
                </div>
                <div class="section">
                    <div id="plantResultText" class="status info">Run plant clustering to see results here.</div>
                </div>
                <div class="section">
                    <label>Plant YAML</label>
                    <textarea id="plantYamlOut" readonly
                        placeholder="Run plant clustering to generate YAML..."></textarea>
                </div>
                <div class="section">
                    <label style="display: flex; align-items: center;">
                        Top candidates for more splits
                        <span class="info-icon"
                            data-tooltip="The 'desired' count (1-5) is calculated using the Capacity and Heat-rate IQR thresholds you set above, plus potential improvement from splitting. It suggests how many clusters would be ideal if the budget allowed.">?</span>
                    </label>
                    <div id="plantCandidateList" class="ba-list">
                        <em>Run plant clustering to see suggestions.</em>
                    </div>
                </div>
            </div>

            <div id="settingsTab" class="tab-content">
                <div class="section">
                    <div style="font-size: 13px; color: #444;">
                        Generate PowerGenome settings YAMLs using your region aggregations and clustering choices.
                        Run region clustering first to populate <em>model_regions</em> and <em>region_aggregations</em>.
                    </div>
                </div>

                <div class="section">
                    <label>Model Definition</label>
                    <label style="font-size: 12px; margin-top: 8px;">Target USD Year</label>
                    <input id="targetUsdYear" type="number" value="2024" min="1900" max="2100" />

                    <label style="font-size: 12px; margin-top: 8px;">UTC Offset</label>
                    <input id="utcOffset" type="number" value="-5" min="-12" max="14" step="1" />

                    <label style="font-size: 12px; margin-top: 8px;">Model Years (comma-separated)</label>
                    <input id="modelYears" type="text" value="2030" />

                    <label style="font-size: 12px; margin-top: 8px;">First Planning Years (comma-separated)</label>
                    <input id="planningYears" type="text" value="2025" />
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Provide the same number of values for model years and first planning years.
                    </div>
                </div>

                <div class="section">
                    <label>Fuels (Baseline)</label>
                    <label style="font-size: 12px;">Fuel Data Year</label>
                    <select id="fuelDataYear"></select>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Uses standard fuels (coal, naturalgas, distillate, uranium). New fuels can be added when
                        creating modified resources.
                    </div>
                </div>

                <div class="section">
                    <label>Fuel Scenarios</label>
                    <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                        Scenario options come from PowerGenome-data fuel_prices.csv for the selected Fuel Data Year.
                        Defaults: coal uses <em>no_111d</em> when available, otherwise <em>reference</em>; all other
                        fuels default to <em>reference</em>.
                    </div>

                    <label style="font-size: 12px;">Coal</label>
                    <select id="fuelScenarioCoal"></select>

                    <label style="font-size: 12px; margin-top: 8px;">Natural gas</label>
                    <select id="fuelScenarioNaturalGas"></select>

                    <label style="font-size: 12px; margin-top: 8px;">Distillate</label>
                    <select id="fuelScenarioDistillate"></select>

                    <label style="font-size: 12px; margin-top: 8px;">Uranium</label>
                    <select id="fuelScenarioUranium"></select>

                    <div id="fuelScenarioHelp" style="font-size: 11px; color: #666; margin-top: 6px;"></div>
                </div>

                <div class="section">
                    <label>New-build Resources</label>
                    <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                        Options load from ATB index (if available). You can still add resources manually.
                    </div>

                    <label style="font-size: 12px;">ATB Data Year</label>
                    <select id="atbYearSelect"></select>

                    <label style="font-size: 12px; margin-top: 8px;">Technology</label>
                    <select id="atbTechSelect"></select>

                    <label style="font-size: 12px; margin-top: 8px;">Tech Detail</label>
                    <select id="atbTechDetailSelect"></select>

                    <label style="font-size: 12px; margin-top: 8px;">Cost Case</label>
                    <select id="atbCostCaseSelect"></select>

                    <label style="font-size: 12px; margin-top: 8px;">Size (MW)</label>
                    <input id="atbSizeMw" type="number" value="1" min="1" step="1" />

                    <button class="btn btn-secondary" id="addNewResourceBtn" type="button">Add New-build
                        Resource</button>

                    <div id="newResourcesList" class="ba-list" style="margin-top: 8px;">
                        <em>No new-build resources selected yet.</em>
                    </div>

                    <label style="font-size: 12px; margin-top: 8px;">Manual new_resources (one per line)</label>
                    <textarea id="newResourcesRaw"
                        style="width: 100%; height: 90px; font-family: monospace; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;"
                        placeholder="Example: NaturalGas | 1-on-1 Combined Cycle (H-Frame) | Moderate | 500"></textarea>
                </div>

                <div class="section">
                    <label>Modified New Resources</label>
                    <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                        Creates entries under <code>modified_new_resources</code>. You will be asked to define the fuel
                        and resource class tags.
                    </div>

                    <label style="font-size: 12px;">Name (key)</label>
                    <input id="modResName" type="text" placeholder="e.g., hydrogen_turbine" />

                    <label style="font-size: 12px; margin-top: 8px;">Copy from: Technology</label>
                    <input id="modBaseTech" type="text" placeholder="e.g., NaturalGas" />

                    <label style="font-size: 12px; margin-top: 8px;">Copy from: Tech Detail</label>
                    <input id="modBaseTechDetail" type="text" placeholder="e.g., 1-on-1 Combined Cycle (H-Frame)" />

                    <label style="font-size: 12px; margin-top: 8px;">Copy from: Cost Case</label>
                    <input id="modBaseCostCase" type="text" placeholder="e.g., Moderate" />

                    <label style="font-size: 12px; margin-top: 8px;">Copy from: Size (MW)</label>
                    <input id="modBaseSizeMw" type="number" value="100" min="1" step="1" />

                    <label style="font-size: 12px; margin-top: 8px;">New: Technology</label>
                    <input id="modNewTech" type="text" placeholder="e.g., hydrogen" />

                    <label style="font-size: 12px; margin-top: 8px;">New: Tech Detail</label>
                    <input id="modNewTechDetail" type="text" placeholder="e.g., 1-on-1 Combined Cycle (H-Frame)" />

                    <label style="font-size: 12px; margin-top: 8px;">New: Cost Case</label>
                    <input id="modNewCostCase" type="text" placeholder="e.g., Moderate" />

                    <label style="font-size: 12px; margin-top: 8px;">Attribute modifiers (optional)</label>
                    <textarea id="modAttrModifiers"
                        style="width: 100%; height: 110px; font-family: monospace; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;"
                        placeholder="Example:
capex_mw: [add, 116000]
heat_rate: [add, 0.365]
fixed_o_m_mw: [add, 9670]
variable_o_m_mwh: [mul, 1.076]
wacc_real: 0.05"></textarea>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        YAML mapping applied under <code>modified_new_resources</code> for this entry.
                    </div>

                    <label style="font-size: 12px; margin-top: 8px;">Fuel Type</label>
                    <select id="modFuelType">
                        <option value="standard" selected>Standard fuel</option>
                        <option value="new">New fuel</option>
                    </select>

                    <div id="modStandardFuelRow" style="margin-top: 8px;">
                        <label style="font-size: 12px;">Standard Fuel</label>
                        <select id="modStandardFuel">
                            <option value="naturalgas" selected>naturalgas</option>
                            <option value="coal">coal</option>
                            <option value="distillate">distillate</option>
                            <option value="uranium">uranium</option>
                        </select>
                    </div>

                    <div id="modNewFuelRow" style="display:none; margin-top: 8px;">
                        <label style="font-size: 12px;">New Fuel Name</label>
                        <input id="modNewFuelName" type="text" placeholder="e.g., hydrogen" />

                        <label style="font-size: 12px; margin-top: 8px;">Fuel Price ($/MMBtu)</label>
                        <input id="modNewFuelPrice" type="number" value="16" min="0" step="0.01" />

                        <label style="font-size: 12px; margin-top: 8px;">Emission Factor (metric ton CO‚ÇÇ/MMBtu)</label>
                        <input id="modNewFuelEf" type="number" value="0" min="0" step="0.00001" />
                    </div>

                    <label style="font-size: 12px; margin-top: 8px;">Resource Class</label>
                    <select id="modTagClass">
                        <option value="THERM" selected>THERM</option>
                        <option value="HYDRO">HYDRO</option>
                        <option value="MUST_RUN">MUST_RUN</option>
                        <option value="VRE">VRE</option>
                        <option value="STOR">STOR</option>
                        <option value="LDS">LDS</option>
                    </select>

                    <div id="modCommitRow" style="margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" id="modIsCommit" style="width: auto; margin: 0;" checked>
                            Also Commit (only relevant for THERM)
                        </label>
                    </div>

                    <button class="btn btn-secondary" id="addModifiedResourceBtn" type="button">Add Modified
                        Resource</button>
                    <button class="btn btn-secondary" id="clearModifiedResourcesBtn" type="button">Clear Modified
                        Resources</button>

                    <div id="modifiedResourcesList" class="ba-list" style="margin-top: 8px;">
                        <em>No modified resources added yet.</em>
                    </div>

                    <script>
                        function toggleModFuelType() {
                            const sel = document.getElementById('modFuelType');
                            const standardRow = document.getElementById('modStandardFuelRow');
                            const newRow = document.getElementById('modNewFuelRow');
                            if (!sel || !standardRow || !newRow) return;
                            if (sel.value === 'new') {
                                standardRow.style.display = 'none';
                                newRow.style.display = 'block';
                            } else {
                                standardRow.style.display = 'block';
                                newRow.style.display = 'none';
                            }
                        }

                        function toggleCommitRow() {
                            const cls = document.getElementById('modTagClass');
                            const row = document.getElementById('modCommitRow');
                            if (!cls || !row) return;
                            row.style.display = (cls.value === 'THERM') ? 'block' : 'none';
                        }

                        document.addEventListener('DOMContentLoaded', function () {
                            const fuelType = document.getElementById('modFuelType');
                            const cls = document.getElementById('modTagClass');
                            if (fuelType) fuelType.addEventListener('change', toggleModFuelType);
                            if (cls) cls.addEventListener('change', toggleCommitRow);
                            toggleModFuelType();
                            toggleCommitRow();
                        });
                    </script>
                </div>

                <div class="section">
                    <button class="btn btn-primary" id="generateSettingsBtn" type="button">Generate Settings
                        YAMLs</button>
                    <div style="display:flex; gap: 8px; align-items: center; margin-top: 8px;">
                        <select id="settingsFileSelect" style="flex: 1;"></select>
                        <button class="btn btn-secondary" id="downloadSettingsFileBtn" type="button">Download</button>
                    </div>
                    <textarea id="settingsYamlOut" readonly
                        style="margin-top: 8px; width: 100%; height: 220px; font-family: monospace; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;"
                        placeholder="Generate settings to preview YAML..."></textarea>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Box selection helper (pure JS for responsiveness) -->
    <script>
        // Box selection state
        window.boxSelectState = {
            enabled: false,
            isDrawing: false,
            startPoint: null,
            boxElement: null
        };

        // Get selected BAs within bounds (called from Python)
        window.getBAsInBounds = function (bounds) {
            return [];
        };
    </script>

    <!-- PyScript config and app -->
    <script type="py" src="./cluster_app.py" config="./pyscript.toml"></script>
</body>

</html>